rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /shipments/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    match /test_shipments/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // New collection for storing manager emails
    match /managers/{email} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.token.email in ['pratikmak2542@gmail.com']; // Only admin can modify managers
    }
    
    // Updated rules for the item_master collections
    match /item_master/{document=**} {
      // Allow read for all authenticated users
      allow read: if request.auth != null;
      // Allow write for admins, managers, and test users
      allow write: if request.auth != null && (
        request.auth.token.email in ['pratikmak2542@gmail.com'] || 
        // Check if user is a manager
        exists(/databases/$(database)/documents/managers/$(request.auth.token.email)) ||
        // Check if the user is a test user (from testAuth)
        exists(/databases/$(database)/documents/test_users/$(request.auth.uid))
      ); 
    }
    
    // Test items collection - ensure full access for test users and regular users
    match /test_item_master/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // New collection to track test users
    match /test_users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /usersData/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /userRequests/{document=**} {
      allow create: if request.auth == null; 
      allow read: if request.auth == null || request.auth.uid != null; // Allow both anonymous & authenticated users to check status
      allow list: if request.auth == null || request.auth.uid != null; // Allow Firestore queries
      allow update, delete: if request.auth != null && (
        request.auth.token.email != null && request.auth.token.email == 'pratikmak2542@gmail.com' || 
        request.auth.token.email == resource.data.email);
    }
  }
}
